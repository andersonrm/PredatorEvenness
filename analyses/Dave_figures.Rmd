---
title: "Dave's figures"
author: "Riley M. Anderson"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  github_document:
    toc: yes
    toc_depth: 5
    pandoc_args: --webtex
  html_document:
    keep_md: yes
    theme: readable
    mathjax: default
  html_notebook:
    code_folding: hide
    theme: readable
    mathjax: default
  pdf_document:
    toc: yes
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
---

```{r setup, include = F}
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Knitr Options
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Set root directory to the project directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())


# Set default knitr options: 
# Suppress warnings and messages, cache chunks, 
#  set default figure size to 6x8 at 300 dpi, and save a png and pdf
knitr::opts_chunk$set(warning = F, message = F, collapse = T, cache = T,
    fig.height = 6, fig.width = 8, dpi = 300, # 6x8" @ 300dpi:1800x2400=4.3MP
    dev = c('png', 'pdf'), dev.args = list(pdf = list(onefile = F)))

```



## Overview

This is a first attempt at plotting Dave's richness/evenness experiment.

All curves are generated by:

$y \sim {\sf Poisson}(\mu_{i})$

$\log(\mu_{i})=\beta_{0}+\beta_{1}x_{i}+\beta_{2}x_{i}^{2}$

where $\mu_{i}$ is the mean of alive beetles, and $x$ is the predator abundance.

## Methods

(1) There were three possible natural enemy species (Bb, Hm, Sc)

(2) Treatments included either 1 species or all 3 species

(3) There were 3 single species treatments (each species by itself)

(4) There were 3 treatments with all three species. In these treatments, we varied the evenness from low to medium to high. In “low” evenness treatments the 3 species were distributed 90%, 5%, 5%. In “medium” evenness treatments the 3 species were distributed 60%, 20%, 20%. In “high evenness treatments the 3 species were distributed 33.3%, 33.3%, 33.3%. We also made sure that each species was the dominant species in an equal number of replicates in “low” in “medium” treatments, so the experiment was fully factorial.

(5) We varied the abundance of individual species and the total community abundance from 100 to 400 to 1000 to 4000 to 10000

### Summary of Results


```{r Main_Code, include = F, cache = F}

# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Setup - This code is run, but output is hidden
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Load Packages
library(tidyverse) # Needed for data wrangling: dplyr, tidyr, ggplot2
library(cowplot) # Needed for publication-quality ggplots


# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
# @@@@@ Data Preparation
# @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

# Import datasets
dat1 <- read.csv("data/dave_data.csv")

```


```{r Data_Wrangling, echo = F, comment = ""}

dat2 <- dat1 %>% 
  mutate(
    Richness = case_when(
      Sc != 0 & Hm == 0 & Bb == 0 ~ 1,
      Sc == 0 & Hm != 0 & Bb == 0 ~ 1,
      Sc == 0 & Hm == 0 & Bb != 0 ~ 1,
      Sc == 0 & Hm == 0 & Bb == 0 ~ 0,
      Sc != 0 & Hm != 0 & Bb != 0 ~ 3,
      TRUE ~ NA),
    num_species = factor(case_when(
    Richness == 1 ~ "one",
    Richness == 3 ~ "three",
    Richness == 0 ~ "control",
    TRUE ~ NA)),
    which_species = factor(case_when(
      num_species == "one" & Sc != 0 ~ "Sc",
      num_species == "one" & Hm != 0 ~ "Hm",
      num_species == "one" & Bb != 0 ~ "Bb",
      TRUE ~ NA
    )),
    Sc_prop = Sc/Total,
    Hm_prop = Hm/Total,
    Bb_prop = Bb/Total,
    Evenness = factor(case_when(
      Sc_prop == 1 | Hm_prop == 1 | Bb_prop == 1 ~ "one",
      Sc_prop == 0.9 | Hm_prop == 0.9 | Bb_prop == 0.9 ~ "low",
      Sc_prop == 0.6 | Hm_prop == 0.6 | Bb_prop == 0.6 ~ "medium",
      Sc_prop > 0.32 & Sc_prop < 0.35 ~ "high",
      num_species == "control" ~ "control",
      TRUE ~ NA
    ), levels = c("one", "control", "low", "medium", "high")),
    dom_species = factor(case_when(
      Sc > Hm & Sc > Bb ~ "Sc",
      Hm > Sc & Hm > Bb ~ "Hm",
      Bb > Sc & Bb > Hm ~ "Bb",
      Sc == Hm & Hm == Bb & Sc != 0 ~ "Perfect evenness",
      TRUE ~ "control"
    ), levels = c("control", "Perfect evenness",
                  "Sc", "Hm", "Bb"))) %>% 
  select(-Treatment)

```



## Evenness as colors with dominant species
```{r evenness_and_dom_preds, echo = F}
dat2 %>% 
  filter(Evenness != "one",
         dom_species != "control") %>% 
  ggplot(aes(x = Total, y = Alive, color = Evenness)) +
  geom_jitter(size = 0.1, width = 50, height = 0.2) +
  geom_smooth(method = 'glm',
              formula = y ~ x + poly(x, 2),
              method.args = list(family = poisson()),
              se = F) +
  facet_wrap(~ dom_species) +
  theme_cowplot(font_size = 16) +
  theme(strip.background = element_blank()) +
  labs(y = "Beetles alive",
       x = "Predator abundance")

```


## Evenness as a facet

```{r test_plots, echo = F, fig.height=4, fig.width=11}

low <- dat2 %>% 
  filter(Evenness == "low") %>% 
  ggplot(aes(x = Total, y = Alive, color = dom_species)) +
  geom_jitter(size = 0.1, width = 50, height = 0.2,
              show.legend = F) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson()),
              formula = y ~ x + poly(x, 2),
              se = F, show.legend = F) +
  theme_cowplot(font_size = 16) +
  labs(x = "Predator abundance",
       y = "Beetles alive",
       color = "Dominant\n  species",
       title = "Low evenness")

medium <- dat2 %>% 
  filter(Evenness == "medium") %>% 
  ggplot(aes(x = Total, y = Alive, color = dom_species)) +
  geom_jitter(size = 0.1, width = 50, height = 0.2) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson()),
              formula = y ~ x + poly(x, 2),
              se = F) +
  theme_cowplot(font_size = 16) +
  labs(x = "Predator abundance",
       y = "Beetles alive",
       color = "Dominant\n  species",
       title = "Medium evenness") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

high <- dat2 %>% 
  filter(Evenness == "high") %>% 
  ggplot(aes(x = Total, y = Alive)) +
  geom_jitter(size = 0.1, width = 50) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson()),
              formula = y ~ x,
              se = F) +
  theme_cowplot(font_size = 16) +
  labs(x = "Predator abundance",
       y = "Beetles alive",
       title = "High evenness") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

plot_grid(low, medium, high,
          nrow = 1, rel_widths = c(0.9, 1, 0.85))
```

## Evenness in one figure, all lines are from richness = 3
```{r evenness_one_graph, echo = F}

dat2 %>% 
  filter(Evenness == "low" |
           Evenness == "medium" |
           Evenness == "high") %>% 
  ggplot(aes(x = Total, y = Alive, colour = Evenness)) +
  geom_jitter(size = 0.2, width = 50, height = 0.2) +
  geom_smooth(method = "glm",
              method.args = list(family = poisson()),
              formula = y ~ x + poly(x, 2), se = F) +
  theme_cowplot(font_size = 16) +
  labs(x = "Predator abundance",
       y = "Beetles alive",
       color = "Evenness")
```


# Richness and evenness in one figure
```{r richness_and_evenness, echo = F}

dat2 %>% 
  filter(Evenness == "low" |
           Evenness == "medium" |
           Evenness == "high" |
           Evenness == "one") %>% 
  ggplot(aes(x = Total, y = Alive, colour = Evenness)) +
  geom_jitter(size = 0.2, width = 50, height = 0.2) +
  geom_smooth(aes(linetype = num_species),
              method = "glm",
              method.args = list(family = poisson()),
              formula = y ~ x + poly(x, 2), se = F) +
  theme_cowplot(font_size = 16) +
  labs(x = "Predator abundance",
       y = "Beetles alive",
       color = "Evenness",
       linetype = "Richness")

```

## Session Information

```{r Session_Info, echo = F, comment = ""}

# Add session information to help with reproduceability
sessionInfo()


```


